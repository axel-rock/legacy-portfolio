<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>Dynamic Content Preview</title>
		<link rel="shortcut icon" href="#">

		<link rel="stylesheet" href="https://jonathan-harrell.com/wp-content/themes/jonathanharrell/node_modules/hiq/dist/hiq.css">
		<style>
			body {
				margin: 0;
				padding: 1rem;
				display: flex;
				flex-direction: column;
			}

			::selection {
				text-shadow: none !important;
				background-color: #eee !important;
				background-color: var(--selection-color);
			}

			fieldset {
				padding: 1rem;
				border-left: solid 1px #fefefe;
				max-width: 500px;
			}

			#banner_selector {
				margin-bottom: 1rem;
			}

			.fields {
				/* box-sizing: content-box; */
				display: grid;
				grid-template-columns: 24% 24% 24% 24%;
				grid-column-gap: 1.25%;
			}

			.fields .field {
				margin-bottom: 1rem;
				max-width: 500px;
				min-width: 20vw;
			}

			#defaults_fields {
				opacity: 0.3;
			}
		</style>
		<!-- <script src="https://s0.2mdn.net/ads/studio/Enabler.js"></script> -->
	</head>
	<body>
		<iframe id="preview" frameBorder="0"></iframe>
		<select id="banner_selector">
			<option value="AO2019_PREevent_all_DCS_300x250">AO2019_PREevent_all_DCS_300x250</option>
			<!-- <option value="test_970x250">test_970x250</option> -->
		</select>
		<form id="form" action="#" method="get">
			<div id="fields" class="fields"></div>
			<div id="defaults_fields" class="fields"></div>
			<input type="submit" name="save" value="Save"/>
			<input type="button" name="reset" value="Reset" onClick="resetDynamicContent()"/>
		</form>
		<script type="text/javascript">
			let data = {
				url: null,
				key: null,
				original: null,
				new: null
			}
			// let banner_selector = document.querySelector('#banner_selector')
			banner_selector.onchange = (e) => {
				createPreview(e.target.value)
			}

			form.onsubmit = replaceDynamicContent

			function createPreview(url) {
				let dimensions = url.match(/\d+x\d+/)[0].split('x')
				data.url = url
				preview.width = dimensions[0]
				preview.height = dimensions[1]
				preview.onload = () => preview.contentWindow.Helper.onReady = loadDynamicContent
				preview.src = data.url
			}

			function loadDynamicContent() {
				data.key = Object.keys(preview.contentWindow.dynamicContent)[0]
				data.original = preview.contentWindow.dynamicContent[data.key][0]

				data.new = data.new || data.original

				fields.innerHTML = ''
				defaults_fields.innerHTML = ''

				for (let key in data.new) {
					createField(key, data.new[key])
				}

				preview.contentWindow.dynamicContent[data.key][0] = data.new
			}

			function resetDynamicContent() {
				data.new = null
				preview.src = data.url
			}

			function replaceDynamicContent(event) {
				event.preventDefault()
				preview.onload = () => preview.contentWindow.Helper.onReady = loadDynamicContent
				preview.src = data.url
			}

			function createField(id, value, name) {
				if (typeof value === 'object') {
					for (let key in value) {
						if (key != 'key')
							createField(key, value[key], id + ' | ' + key)
					}
				} else {
					let div = document.createElement('div')
						div.classList.add('field')
					let label = document.createElement('label')
						label.htmlFor = id
						label.innerHTML = name || id
					let input = document.createElement('input')
						input.type = value == parseInt(value) ? 'number' : 'text'
						// input.type = /^#[0-9A-F]{6}$/i.test(value) ? 'color' : 'text'
						input.id = id
						input.name = id
						input.value = value
					input.onchange = (e) => {
						data.new[e.target.name] = e.target.value
					}
					div.appendChild(label)
					div.appendChild(input)
					if (id == '_id' || id == 'Unique_ID' || id == 'Reporting_Label' || id == 'Targeting_Column')
						defaults_fields.appendChild(div)
					else
						fields.appendChild(div)

				}
			}

			createPreview(banner_selector.options[0].value)
		</script>
	</body>
</html>
